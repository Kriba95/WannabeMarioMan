
kaboom({
  global: true,
  fullscreen: true,
  scale: 0.5,
  debug: true,
  clearColor: [0, 0, 0, 1],
})

const MOVE_SPEED = 450
const JUMP_FORCE = 503
const BIG_JUMP_FORCE = 550
let CURRENT_JUMP_FORCE = JUMP_FORCE
const FALL_DEATH = 2500
const ENEMY_SPEED = 20


let isJumping = true

loadRoot('http://localhost/game/wnbMario/enginamus/assets/')
loadSprite('coin', 'Items/coinGold.png')
loadSprite('brick', 'Tiles/bridge.png')
loadSprite('mario', 'Player/p1_stand.png')
loadSprite('sieni', 'Items/sieniBrown.png')

loadSprite('unboxed', 'Tiles/box.png')
loadSprite('pipe-top-left', 'Tiles/door_closedMid.png')
loadSprite('pipe-bottom-right', 'Tiles/door_closedTop.png')
loadSprite('blue-block', 'Tiles/stoneMid.png')
loadSprite('blue-brick', 'Tiles/stoneMid.png')
loadSprite('blue-steel', 'Tiles/stoneMid.png')
loadSprite('blue-surprise', 'Tiles/stoneMid.png')
// Enemy
loadSprite('flyFly1', 'Enemies/flyFly1.png')
loadSprite('blockerMad', 'Enemies/blockerMad.png')

// ovi
loadSprite('door_closedTop', 'Tiles/door_closedTop.png')
loadSprite('door_closedMid', 'Tiles/door_closedMid.png')

// Boksit
loadSprite('boxAlt', 'Tiles/boxAlt.png')
loadSprite('boxItem', 'Tiles/boxItem.png')
loadSprite('boxItemAlt', 'Tiles/boxItemAlt.png')

// Tiles
loadSprite('blockMid', 'Tiles/grassMid.png')
loadSprite('sandMid', 'Tiles/sandMid.png')
loadSprite('snowMid', 'Tiles/snowMid.png')








scene("game", ({ level, score }) => {
  layers(['bg', 'obj', 'ui'], 'obj')
  
  // Kartta on tehty Excelillä, .ODS tiedosto

  const maps = [
    // Taso 1
    [
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '.......................................xxxx.........................x.............................x.............',
      '......................................x.............................x.............................x.............',
      '.....................................x...........................x..x.............................x.............',
      '.................................x............xx.................x..x.............................x.............',
      '.....................x...xxxxxxxx...............x..............x.x..x.............................x.............',
      '.................................................xx............x.x..xx............................x.............',
      '...................x................................x.........xx.x..xx............................x.......f..f..',
      '....................x.........................................xx.x..xx.....f......................x....xxxxxxxxx',
      '..........................x....%*x.......................xx..xxx.x..%x...xxxxx....................x.............',
      '.....................x...................................................x........................x.............',
      '......................x.................................................fx.....x..................x.............',
      '......................xxxxx....xxxxxx........................xxxxxxx*xxxxx....f.x.x...x...x..xxxxxx.............',
      '.....................................x.......................x................x............................x....',
      '.............................................................x...............x.............................x....',
      '.......................................x.....................xxxxxxxxxxxx..xx..........................x...x....',
      '........................................x....................x..........x..............................x...x....',
      '.........................................xxxxx...............x..........xx..........................x..x...x....',
      '...........................................xxxx..............x...........x...................xxxxxxxx......x....',
      '.............................................................x.%%%%...x....xx................x.....xxx..........',
      '.................................................xxx.........x..............x................x.....xxxxxxxx.x...',
      '.....................................xx....xxxxxxxxxxxx......x..........xxx..................x.....xxxx.........',
      '...............xxxx%x...............xxx......................x.xxx...........................x..................',
      '...................................xxxxx.....................x.......x.......................x............T.....',
      '.........................x........xxxxxxx.............d.....dx........x.........d...........zx.....z......|.....',
      '================================================================================================================',
            
    ],

    //Taso Kaksi
      [
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '.......................................xxxx.........................x.............................x.............',
      '......................................x.............................x.............................x.............',
      '.....................................x...........................x..x.............................x.............',
      '.................................x............xx.................x..x.............................x.............',
      '.....................x...xxxxxxxx...............x..............x.x..x.............................x.............',
      '.................................................xx............x.x..xx............................x.............',
      '...................x................................x.........xx.x..xx............................x.......f..f..',
      '....................x.........................................xx.x..xx.....f......................x....xxxxxxxxx',
      '..........................x....%*x.......................xx..xxx.x..%x...xxxxx....................x.............',
      '.....................x...................................................x........................x.............',
      '......................x.................................................fx.....x..................x.............',
      '......................xxxxx....xxxxxx........................xxxxxxx*xxxxx....f.x.x...x...x..xxxxxx.............',
      '.....................................x.......................x................x............................x....',
      '.............................................................x...............x.............................x....',
      '.......................................x.....................xxxxxxxxxxxx..xx..........................x...x....',
      '........................................x....................x..........x..............................x...x....',
      '.........................................xxxxx...............x..........xx..........................x..x...x....',
      '...........................................xxxx..............x...........x...................xxxxxxxx......x....',
      '.............................................................x.%%%%...x....xx................x.....xxx..........',
      '.................................................xxx.........x..............x................x.....xxxxxxxx.x...',
      '.....................................xx....xxxxxxxxxxxx......x..........xxx..................x.....xxxx.........',
      '...............xxxx%x...............xxx......................x.xxx...........................x..................',
      '....xx.............................xxxxx.....................x.......x.......................x............T.....',
      '.........................x........xxxxxxx.............d.....dx........x.........d...........zx.....z......|.....',
      '================================================================================================================',
            
    ],
    // Taso Kolme
    
    [
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '..................................................................................................x.............',
      '.......................................xxxx.........................x.............................x.............',
      '......................................x.............................x.............................x.............',
      '.....................................x...........................x..x.............................x.............',
      '.................................x............xx.................x..x.............................x.............',
      '.....................x...xxxxxxxx...............x..............x.x..x.............................x.............',
      '.................................................xx............x.x..xx............................x.............',
      '...................x................................x.........xx.x..xx............................x.......f..f..',
      '....................x.........................................xx.x..xx.....f......................x....xxxxxxxxx',
      '..........................x....%*x.......................xx..xxx.x..%x...xxxxx....................x.............',
      '.....................x...................................................x........................x.............',
      '......................x.................................................fx.....x..................x.............',
      '......................xxxxx....xxxxxx........................xxxxxxx*xxxxx....f.x.x...x...x..xxxxxx.............',
      '.....................................x.......................x................x............................x....',
      '.............................................................x...............x.............................x....',
      '.......................................x.....................xxxxxxxxxxxx..xx..........................x...x....',
      '........................................x....................x..........x..............................x...x....',
      '.........................................xxxxx...............x..........xx..........................x..x...x....',
      '...........................................xxxx..............x...........x...................xxxxxxxx......x....',
      '.............................................................x.%%%%...x....xx................x.....xxx..........',
      '.................................................xxx.........x..............x................x.....xxxxxxxx.x...',
      '.....................................xx....xxxxxxxxxxxx......x..........xxx..................x.....xxxx.........',
      '....x..........xxxx%x...............xxx......................x.xxx...........................x..................',
      '...................................xxxxx.....................x.......x.......................x............T.....',
      '.........................x........xxxxxxx.............d.....dx........x.........d...........zx.....z......|.....',
      '================================================================================================================',
            
    ],

  ]

  const levelCfg = {
    width: 70,
    height: 70,

    // SCALE (scale(1) on vakio koko, sitä pienempi desimaali sitä pienempi kuva) 
    // Solid = läpi ei voi kulkea. 
    // Dangerous = jos osuu häviää pelin
    // Suurentaa pelihahmon

    '$': [sprite('coin'), 'coin'],
    '}': [sprite('unboxed'), solid()],
    ')': [sprite('pipe-bottom-right'), solid(), scale(0.5)],
    '#': [sprite('sieni'), solid(), 'sieni', body(), scale(1)],
    '!': [sprite('blue-block'), solid(), scale(0.5)],
    '£': [sprite('blue-brick'), solid(), scale(0.5)],
    '@': [sprite('blue-surprise'), solid(), scale(0.5), 'coin-surprise'],
    // Enemy
    'f': [sprite('flyFly1'), solid(), 'dangerous'],
    'z': [sprite('blockerMad'), solid(), 'dangerous'],
    'd': [sprite('blockerMad'), solid(), scale(1),'dangerous'],



    // Ovi
    'T': [sprite('door_closedTop'), scale(1), 'pipe'],
    '|': [sprite('door_closedMid'), scale(1)],


    // Boxi
    'x': [sprite('boxAlt'), solid()],
    '%': [sprite('boxItem'), solid(), 'coin-surprise'],
    '*': [sprite('boxItemAlt'), solid(), 'sieni-surprise'],

    // Tiles
    '=': [sprite('blockMid'), solid()],
    '_': [sprite('sandMid'), solid()],
    '-': [sprite('snowMid'), solid()],


  }

  // Kun taso on läpäisty tulee uusi taso
  const gameLevel = addLevel(maps[level], levelCfg)


  const scoreLabel = add([
    text(score),
    pos(0, 0),
    layer('ui'),
    {
      value: score,
    }
  ])

  // "Level tekstin Sijainti. *.0 Tärkeä"
  add([text('level ' + parseInt(level + 1) ), pos(40, 0)])
  
  function big() {
    let timer = 0
    let isBig = false
    return {
      update() {
        if (isBig) {
          CURRENT_JUMP_FORCE = BIG_JUMP_FORCE
          timer -= dt()
          if (timer <= 0) {
            this.smallify()
          }
        }
      },
      isBig() {
        return isBig
      },
      smallify() {
        this.scale = vec2(1)
        CURRENT_JUMP_FORCE = JUMP_FORCE
        timer = 0
        isBig = false
      },
      biggify(time) {
        this.scale = vec2(1.5)
        timer = time
        isBig = true     
      }
    }
  }

  const player = add([
    sprite('mario'), solid(),
    pos(30, 0),
    body(),
    big(),
    origin('bot')
  ])

  action('sieni', (m) => {
    m.move(20, 0)
  })

  player.on("headbump", (obj) => {
    if (obj.is('coin-surprise')) {
      gameLevel.spawn('$', obj.gridPos.sub(0, 1))
      destroy(obj)
      gameLevel.spawn('}', obj.gridPos.sub(0,0))
    }
    if (obj.is('sieni-surprise')) {
      gameLevel.spawn('#', obj.gridPos.sub(0, 1))
      destroy(obj)
      gameLevel.spawn('}', obj.gridPos.sub(0,0))
    }
  })

  player.collides('sieni', (m) => {
    destroy(m)
    player.biggify(6)
  })

  player.collides('coin', (c) => {
    destroy(c)
    scoreLabel.value++
    scoreLabel.text = scoreLabel.value
  })

  action('dangerous', (d) => {
    d.move(-ENEMY_SPEED, 0)
  })

  player.collides('dangerous', (d) => {
    if (isJumping) {
      destroy(d)
    } else {
      go('lose', { score: scoreLabel.value})
    }
  })

  player.action(() => {
    camPos(player.pos)
    if (player.pos.y >= FALL_DEATH) {
      go('lose', { score: scoreLabel.value})
    }
  })

  player.collides('pipe', () => {
    keyPress('e', () => {
      go('game', {
        level: (level + 1) % maps.length,
        score: scoreLabel.value
      })
    })
  })

  keyDown('left', () => {
    player.move(-MOVE_SPEED, 0)
  })

  keyDown('right', () => {
    player.move(MOVE_SPEED, 0)
  })

  player.action(() => {
    if(player.grounded()) {
      isJumping = false
    }
  })

  keyPress('space', () => {
    if (player.grounded()) {
      isJumping = true
      player.jump(CURRENT_JUMP_FORCE)
    }
  })
})

scene('lose', ({ score }) => {
  add([text(score, 32), origin('center'), pos(width()/2, height()/ 2)])
  add([text("Created by, Kristian Tollikko", 30), origin('center'), pos(width()/2, height()/ 1.8)])

})

start("game", { level: 0, score: 0})
